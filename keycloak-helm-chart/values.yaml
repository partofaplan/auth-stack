# Default values for Keycloak with Rancher integration
# This is a YAML-formatted file.

# Keycloak Configuration
keycloak:
  # Number of Keycloak replicas for high availability
  replicas: 2

  image:
    repository: quay.io/keycloak/keycloak
    tag: "24.0.1"
    pullPolicy: IfNotPresent

  # Keycloak admin credentials
  auth:
    adminUser: admin
    # adminPassword: "" # Should be set via --set or stored in external secret
    existingSecret: ""  # Name of existing secret with admin credentials
    existingSecretKey: "password"

  # Keycloak configuration
  configuration:
    # Database configuration
    database:
      vendor: postgres
      hostname: ""  # Will use internal PostgreSQL if empty
      port: 5432
      database: keycloak
      username: keycloak
      # password: "" # Should be set via --set or stored in external secret
      existingSecret: ""
      existingSecretKey: "db-password"

    # Keycloak hostname
    hostname: keycloak.example.com
    hostnameStrict: false
    hostnameStrictBackchannel: false

    # HTTP/HTTPS configuration
    http:
      enabled: true
      port: 8080
    https:
      enabled: false
      port: 8443

    # Proxy configuration (important for Rancher/Ingress)
    proxy: edge  # Options: edge, reencrypt, passthrough

    # Health check configuration
    healthEnabled: true
    metricsEnabled: true

    # Cache configuration for clustering
    cache:
      stack: kubernetes

    # Logging
    logLevel: INFO

  # Resource limits
  resources:
    requests:
      cpu: 500m
      memory: 512Mi
    limits:
      cpu: 2000m
      memory: 2Gi

  # Liveness and readiness probes
  livenessProbe:
    httpGet:
      path: /health/live
      port: 8080
    initialDelaySeconds: 300
    periodSeconds: 30
    timeoutSeconds: 5
    failureThreshold: 3

  readinessProbe:
    httpGet:
      path: /health/ready
      port: 8080
    initialDelaySeconds: 60
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  # Startup probe for slower startups
  startupProbe:
    httpGet:
      path: /health/started
      port: 8080
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 30

  # Additional environment variables
  extraEnv: []
  # - name: CUSTOM_VAR
  #   value: "custom-value"

  # Pod annotations
  podAnnotations: {}

  # Pod security context
  podSecurityContext:
    fsGroup: 1000

  # Container security context
  securityContext:
    runAsUser: 1000
    runAsNonRoot: true

  # Node selector
  nodeSelector: {}

  # Tolerations
  tolerations: []

  # Affinity rules
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                    - keycloak
            topologyKey: kubernetes.io/hostname

# Service Configuration
service:
  type: ClusterIP
  port: 8080
  httpsPort: 8443
  annotations: {}
  # For Rancher LoadBalancer integration
  # annotations:
  #   metallb.universe.tf/address-pool: production

  # Headless service for StatefulSet
  headless:
    annotations: {}

# Ingress Configuration (Rancher-ready)
ingress:
  enabled: true
  className: "nginx"  # Use "traefik" for Rancher's default
  annotations:
    # Rancher-specific annotations
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/proxy-buffer-size: "128k"
    nginx.ingress.kubernetes.io/proxy-buffering: "on"
    nginx.ingress.kubernetes.io/proxy-buffers-number: "4"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    # For Rancher authentication integration
    # rancher.io/globalDNS.hostname: "keycloak.example.com"

  hosts:
    - host: keycloak.example.com
      paths:
        - path: /
          pathType: Prefix

  tls:
    - secretName: keycloak-tls
      hosts:
        - keycloak.example.com

# PostgreSQL Configuration (using Bitnami chart)
postgresql:
  enabled: true
  auth:
    username: keycloak
    password: ""  # Should be set via --set
    database: keycloak
    existingSecret: ""

  primary:
    persistence:
      enabled: true
      size: 8Gi
      storageClass: ""  # Use default storage class or specify Rancher storage class

    resources:
      requests:
        cpu: 250m
        memory: 256Mi
      limits:
        cpu: 1000m
        memory: 1Gi

  # For production, consider enabling replication
  readReplicas:
    replicaCount: 0

# Persistence for Keycloak (themes, providers, etc.)
persistence:
  enabled: true
  storageClass: ""  # Use default or specify Rancher storage class
  accessMode: ReadWriteOnce
  size: 1Gi
  # For shared storage across replicas, use ReadWriteMany
  # accessMode: ReadWriteMany

# Service Account
serviceAccount:
  create: true
  annotations: {}
  name: ""

# RBAC Configuration
rbac:
  create: true
  rules:
    - apiGroups: [""]
      resources: ["pods"]
      verbs: ["get", "list"]

# Rancher-specific Configuration
rancher:
  # Enable Rancher monitoring integration
  monitoring:
    enabled: true
    serviceMonitor:
      enabled: true
      interval: 30s
      scrapeTimeout: 10s

  # Rancher project/namespace annotations
  projectId: ""  # Set this to your Rancher project ID

  # Rancher catalog configuration
  catalog:
    # Questions for Rancher UI
    questions:
      - variable: keycloak.auth.adminUser
        label: "Keycloak Admin Username"
        type: string
        required: true
        default: "admin"
      - variable: keycloak.auth.adminPassword
        label: "Keycloak Admin Password"
        type: password
        required: true
      - variable: keycloak.configuration.hostname
        label: "Keycloak Hostname"
        type: string
        required: true
        default: "keycloak.example.com"
      - variable: postgresql.auth.password
        label: "Database Password"
        type: password
        required: true

# Network Policy (optional, for security)
networkPolicy:
  enabled: false
  ingress:
    - from:
      - namespaceSelector:
          matchLabels:
            name: ingress-nginx
      ports:
      - protocol: TCP
        port: 8080

# Pod Disruption Budget for high availability
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Autoscaling (optional)
autoscaling:
  enabled: false
  minReplicas: 2
  maxReplicas: 5
  targetCPUUtilizationPercentage: 80
  targetMemoryUtilizationPercentage: 80
