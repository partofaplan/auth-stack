# Rancher-optimized values for Keycloak
# This configuration is optimized for deployment in Rancher environments

keycloak:
  replicas: 2

  image:
    repository: quay.io/keycloak/keycloak
    tag: "24.0.1"
    pullPolicy: IfNotPresent

  auth:
    adminUser: admin
    adminPassword: ""  # Set via Rancher UI or secrets

  configuration:
    hostname: keycloak.local
    hostnameStrict: false
    hostnameStrictBackchannel: false

    http:
      enabled: true
      port: 8080

    https:
      enabled: false
      port: 8443

    # Edge proxy mode for Traefik/NGINX ingress
    proxy: edge

    healthEnabled: true
    metricsEnabled: true

    cache:
      stack: kubernetes

    logLevel: INFO

  resources:
    requests:
      cpu: 500m
      memory: 512Mi
    limits:
      cpu: 2000m
      memory: 2Gi

  # Pod anti-affinity for better distribution across nodes
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                    - keycloak
            topologyKey: kubernetes.io/hostname

service:
  type: ClusterIP
  port: 8080
  httpsPort: 8443
  annotations: {}

# Ingress with Traefik (Rancher's default)
ingress:
  enabled: true
  className: "traefik"
  annotations:
    # Traefik annotations
    traefik.ingress.kubernetes.io/router.entrypoints: "websecure"
    traefik.ingress.kubernetes.io/router.tls: "true"
    # Cert-manager for automatic TLS
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    # Additional Rancher annotations
    field.cattle.io/publicEndpoints: '[{"addresses":["keycloak.local"],"port":443,"protocol":"HTTPS","serviceName":"keycloak","ingressName":"keycloak","hostname":"keycloak.local","allNodes":false}]'

  hosts:
    - host: keycloak.local
      paths:
        - path: /
          pathType: Prefix

  tls:
    - secretName: keycloak-tls
      hosts:
        - keycloak.local

# PostgreSQL with Longhorn storage (Rancher's default)
postgresql:
  enabled: true
  auth:
    username: keycloak
    password: ""  # Set via Rancher UI
    database: keycloak

  primary:
    persistence:
      enabled: true
      size: 8Gi
      storageClass: "longhorn"  # Rancher's Longhorn storage

    resources:
      requests:
        cpu: 250m
        memory: 256Mi
      limits:
        cpu: 1000m
        memory: 1Gi

  readReplicas:
    replicaCount: 0

# Persistence using Longhorn
persistence:
  enabled: true
  storageClass: "longhorn"
  accessMode: ReadWriteOnce
  size: 1Gi

# Service Account
serviceAccount:
  create: true
  annotations: {}
  name: ""

# RBAC
rbac:
  create: true
  rules:
    - apiGroups: [""]
      resources: ["pods"]
      verbs: ["get", "list"]

# Rancher-specific configuration
rancher:
  # Set your Rancher project ID
  # Find it in: Rancher UI -> Cluster -> Projects/Namespaces
  # Format: c-xxxxx:p-xxxxx
  projectId: ""

  # Enable Rancher monitoring integration
  monitoring:
    enabled: true
    serviceMonitor:
      enabled: true
      interval: 30s
      scrapeTimeout: 10s

  # Rancher catalog configuration
  catalog:
    questions:
      - variable: keycloak.auth.adminUser
        label: "Keycloak Admin Username"
        type: string
        required: true
        default: "admin"
      - variable: keycloak.auth.adminPassword
        label: "Keycloak Admin Password"
        type: password
        required: true
      - variable: keycloak.configuration.hostname
        label: "Keycloak Hostname"
        type: string
        required: true
        default: "keycloak.local"
      - variable: postgresql.auth.password
        label: "Database Password"
        type: password
        required: true

# Pod Disruption Budget
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Autoscaling (disabled by default, enable if needed)
autoscaling:
  enabled: false
  minReplicas: 2
  maxReplicas: 5
  targetCPUUtilizationPercentage: 80
  targetMemoryUtilizationPercentage: 80

# Network Policy (optional - Rancher has its own network policies)
networkPolicy:
  enabled: false
