# Values for Keycloak with External PostgreSQL Database
# This configuration disables the bundled PostgreSQL and uses an external database

keycloak:
  replicas: 2

  image:
    repository: quay.io/keycloak/keycloak
    tag: "24.0.1"
    pullPolicy: IfNotPresent

  auth:
    adminUser: admin
    adminPassword: ""  # Set via --set or use existingSecret
    existingSecret: ""  # Name of existing secret with admin credentials
    existingSecretKey: "password"

  configuration:
    # External database configuration
    database:
      vendor: postgres
      hostname: ""  # REQUIRED: Your PostgreSQL hostname (e.g., postgres.example.com)
      port: 5432
      database: keycloak  # Database name
      username: keycloak  # Database username
      password: ""  # Set via --set or use existingSecret
      existingSecret: ""  # Name of existing secret with database password
      existingSecretKey: "password"

    # Keycloak hostname
    hostname: keycloak.example.com
    hostnameStrict: false
    hostnameStrictBackchannel: false

    # HTTP/HTTPS configuration
    http:
      enabled: true
      port: 8080
    https:
      enabled: false
      port: 8443

    # Proxy configuration (important for Rancher/Ingress)
    proxy: edge

    # Health check configuration
    healthEnabled: true
    metricsEnabled: true

    # Cache configuration for clustering
    cache:
      stack: kubernetes

    # Logging
    logLevel: INFO

  # Resource limits
  resources:
    requests:
      cpu: 500m
      memory: 512Mi
    limits:
      cpu: 2000m
      memory: 2Gi

  # Liveness and readiness probes
  livenessProbe:
    httpGet:
      path: /health/live
      port: 8080
    initialDelaySeconds: 300
    periodSeconds: 30
    timeoutSeconds: 5
    failureThreshold: 3

  readinessProbe:
    httpGet:
      path: /health/ready
      port: 8080
    initialDelaySeconds: 60
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  startupProbe:
    httpGet:
      path: /health/started
      port: 8080
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 30

  # Pod anti-affinity for HA
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                    - keycloak
            topologyKey: kubernetes.io/hostname

# Service Configuration
service:
  type: ClusterIP
  port: 8080
  httpsPort: 8443
  annotations: {}

  headless:
    annotations: {}

# Ingress Configuration
ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/proxy-buffer-size: "128k"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"

  hosts:
    - host: keycloak.example.com
      paths:
        - path: /
          pathType: Prefix

  tls:
    - secretName: keycloak-tls
      hosts:
        - keycloak.example.com

# DISABLE the bundled PostgreSQL
postgresql:
  enabled: false

# Persistence for Keycloak (themes, providers, etc.)
persistence:
  enabled: true
  storageClass: ""
  accessMode: ReadWriteOnce
  size: 1Gi

# Service Account
serviceAccount:
  create: true
  annotations: {}
  name: ""

# RBAC Configuration
rbac:
  create: true
  rules:
    - apiGroups: [""]
      resources: ["pods"]
      verbs: ["get", "list"]

# Rancher-specific Configuration
rancher:
  monitoring:
    enabled: true
    serviceMonitor:
      enabled: true
      interval: 30s
      scrapeTimeout: 10s

  projectId: ""

# Pod Disruption Budget
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Autoscaling (optional)
autoscaling:
  enabled: false
  minReplicas: 2
  maxReplicas: 5
  targetCPUUtilizationPercentage: 80
  targetMemoryUtilizationPercentage: 80
